LJ export, a mere python script
===============================

## How it works

Please input the cyrillic text below in google translate or any other auto-translator RU→EN to read this readme file.


## Как это работает:

Записи скачиваются в файлы *.htm в папку, названную по имени пользователя, дале в папки по годам и внутри них по месяцам.
За каждый год и месяц формируются отчёты о загрузке и содержании записей, см. ниже.
Средствами работы с файлами можно посмотреть отчёты все вместе в одном листинге за год или неск. лет, если нужно
(например, командой `more`, работающей с терминала во всех ОС).
По скачанным записям средствами работы с файлами (`grep`, `cat`, `sort` и т.п.) можно делать поиск и выборку текстов
по содержанию/тэгам/временному интервалу, в т.ч. анализ на часто встречаемые слова/выражения и пр. — 
всё то, что можно делать с текстами.
Каждый *.htm обработывается функцией prettify в т.ч. для удобства поиска, т.к. сам html-код ЖЖ именно там, где идёт ваша запись вытянут в одну строку.

Попутно из кода вычищается мусор с тэгами `<span>`, ибо это часто доходит аж до такого ужаса:

![мусорный код ЖЖ пример раз](http://www.canitell.ru/imgs/livejougit/LJcodeRubbishShame.png)

— такая цепочка получается после prettify() — в оригинале зачем-то понадобилось открывать такую уйму этих тэгов внутри обычной записи пользователя.
По возможности вычищается реклама, встраеваемая внутри записи.
И уж конечно грязь такого рода вычищается автоматом тем более:

![мусорный код ЖЖ пример раз](http://www.canitell.ru/imgs/livejougit/LJcodeRubbishAwfulShame.png)

— кодеры ЖЖ умудряются зачем-то вставлять сие прямо в html как код javascript (в переменную Site.ml_text) даже в страницы архивных (календарных) списков записей пользователя.
Зачем-то это там…

В остатке — вы получаете сохранёнными только и только то, что находится внутри тех тэгов, которые содержат вашу запись
(но см. так же ниже — почему здесь может понадобиться ваше участие в настройках этого экспорта).

Так же, если выбирается опция скачивания картинок, то все ссылки на них автоматически проверяются на доступность и о том генерируются отчёты.
Все доступные (с места запуска скрипта — для России эта доступность не такая, как для др. стран теперь) 
картинки скачиваются если выбрана соответствующая опция, их пути в локальных копиях записей меняются на локальные.

_Подзамочные записи не грузятся_ 
(для этого в скрипт надо добавить модуль авторизации, что м.б. будет потом добавлено как опция, а м.б. и не будет).


См. `config.py` и следующие рекомендации чтобы ваc не забанили как бота:
1. скрипт можно использовать как есть, а можно вставить побольше и/или других (лучше других) своих user-agents, через запятую в поле внутри квадратных скобок к
ключу-параметру "User-Agent" в функции random.choice(); последнее желательно и обеспечит меньший риск бана
2. не торопитесь: не уменьшайте время между запросами к серверу ЖЖ (ключ-параметр "pause" в config.py)
если не хотите рискнуть, иначе ПО сервера ЖЖ вас тогда проще заметит как бота и
забанит по IP
3. если торопитесь, то используйте системный VPN или proxychains
4. см. ниже примеры запуска скрипта 
5. предупреждение: вас всё равно могут забанить как бота просто потому, что
владельцы ЖЖ не хотят, чтобы его пользователи полностью контролировали свои
записи: имели полнотекстовый поиск по ним, могли проверить актуальность ссылок на
картинки или вообще имели наглость желать скачивать свои записи... а то и не
свои.. ещё и анализировать свои или чьи-либо ещё тексты без связи с интернетом.. ай-яй-яй!
6. вы используете скрипт на свой страх и риск: старайтесь не
перегружать бестолку сервер ЖЖ и не заваливать его многими тыщами запросов
в сутки, записи можно сгружать и в расслабленном режиме — т.е. не боле 1-2
тысячи в сутки… а если вы шпарите по несколько десятков записей в день, то
отвлекитесь на математику, чтобы посчитать за сколько месяцев вы можете
сгрузить их себе, не выглядя для сервера слишком ботоголово…


## Установка (Linux/M$/Mac OS):

1. скачайте и установите 3-ий пайтон, репозиторий пайтона: https://www.python.org/ftp/python/ версии от 3.4 _соответсвующей архитектуре вашего компьютера_
2. убедитесь, что у вас стоит загрузчик пайтоновских модулей pip, в версии от 3.4 он ставится по умолчанию
3. если у вас M$ Windows, то следуйте инструкциям по установке пайтона здесь: https://www.youtube.com/watch?v=KY9jJ3kghq4
— не забудьте проставить галочку Add Python*.* to PATH (добавить Python в пути) и скачивайте его 
с официального сайта: https://www.python.org/downloads/windows/ (можно скачивать последнюю версию, _соответсвующую архитектуре вашего компьютера_);
у пользователей M$ Windows всё равно могут возникнуть проблемы с путями, т.к. эта ОС не очень умеет работать с файловой системой без перезагрузки её
4. распакуйте из архива или скачайте файлы: `requirements.txt`, `config.py`, `LJexport.py` в ту папку, куда хотите экспортировать записи
5. запустите в терминале из этой папки (для установки модулей пайтон, которые обычно не входят в его базовую установку):

`pip install -r requirements.txt`

если стоит ещё 2ой пайтон, то тогда 

`pip3 install -r requirements.txt`

для пользователей Windows: если `pip` всё равно почему-то не запускается, то запускайте его, скажем, так:

`C:\Journal>..\Python\Scripts\pip.exe install -r requirements.txt`

— в папку C:\Journal вы сгрузили вышеуказанные 3 файла, а в папку C:\Python поставили пайтон

Если вдруг окажется, что какого-то используемого модуля всё равно нет, то пайтон будет ругаться, скажем, если нет обычно базового модуля codecs, то он выкинет:

```
NameError: name 'codecs' is not defined
```
— тогда доставьте этот модуль так же, т.е.:

`pip install codecs`

## Проверка работы скрипта:

1. спросите у скрипта как его использовать, запустите в терминале:

`python LJexport.py -h` 

или

`python3 LJexport.py -h` (если стоит пайтон2 и команда python залинкована на 2ой)

Можно запускать так же как

`./LJexport.py -h` (Linux/Mac)

`.\LJexport.py -h` (Windows)


2. запустите выгрузку статистики журнала юзернейм (например, это frank) за тeкущий год/текущий месяц:

`python LJexport.py -j frank -s 1`

Если ошибок не выдано, то всё отлично, можно продолжать с другими журналами.


## Примеры использования скрипта:

1. загрузка записей frank-а за текущий год и месяц без картинок (по умолчанию, без явно указанного к опции -i значения картинки не грузятся)

`python3 LJexport.py -j frank`

2. то же самое с картинками и за все месяцы текущего года

`python3 LJexport.py -j frank -m all -i 1`

3. загрузка записей frank-а за текущий год и все его месяцы без картинок

`python3 LJexport.py -j frank -m all`

4. выгрузка записей frank-а за 2020 год и три последних его месяца с картинками

`python3 LJexport.py -j frank -у 2020 -m 10,11,12 -i 1`


## Если записи не грузятся:

```
!! POST's STYLE: no content parsed! please add post content's style in config ("usercontent_classes")
```

— _возможна ошибка при выгрузке записей, если стиль журнала не указан в_ **config.py**: см.
ключ-параметр "usercontent_classes" — эти значения можно найти следующим образом.
Открываете нужную запись, далее Ctrl+U (или «View Page Source»\«Исходный код страницы»), это здесь:

![мусорный код ЖЖ пример раз](http://www.canitell.ru/imgs/livejougit/usercontent_classes_exmpl1.png)

или здесь (class тэга div "b-singlepost-bodywrapper" тоже пойдёт, но и классы тэга article на всякий случай обрабатываются):

![мусорный код ЖЖ пример два](http://www.canitell.ru/imgs/livejougit/usercontent_classes_exmpl2.png)

или здесь:

![мусорный код ЖЖ пример три](http://www.canitell.ru/imgs/livejougit/usercontent_classes_exmpl3.png)

или здесь:

![мусорный код ЖЖ пример четыре](http://www.canitell.ru/imgs/livejougit/usercontent_classes_exmpl4.png)

или здесь:

![мусорный код ЖЖ пример пять](http://www.canitell.ru/imgs/livejougit/usercontent_classes_exmpl5.png)

или здесь:

![мусорный код ЖЖ пример пять](http://www.canitell.ru/imgs/livejougit/usercontent_classes_exmpl6.png)


В **config.py** учитывается больше вариантов стилей, чем в примерах выше, но ковыряться и домогаться до удовлетворения жажды знания того, 
сколько их всего (а ещё и каких именно…) понаплодили креативные кодеры ЖЖ — совсем-совсем неинтересно, извините.

Код ЖЖ — это такая каша, в каждом журнале свои стили, притом в целом они никак не стандартизированы и даже не типизированы: мало того, что разные стили css, 
так ещё и даже разный код html, т.е. разные html-тэги.
Зачем-то.

Так что если параметры стиля сгружаемой страницы не указаны к "usercontent_classes" в `config.py`, то пробуйте найти их в коде страницы записи и вставить в конфиг (аккуратно).


## Примеры отчётов загрузки записей:

Репосты также должны сгрузиться, если стиль соответствующего журнала внесён в config.py (см. выше):

![пример отчёта загрузки записей раз](http://www.canitell.ru/imgs/livejougit/With-images-tbl-example-with-repost.png)

Картинки тоже сгрузятся, переименуются и вставятся в локальную копию htm файла, их оригинальный адрес будет указан в отчёте:

![пример отчёта загрузки записей раз](http://www.canitell.ru/imgs/livejougit/With-images-tbl-example-no-repost.png)

Если картинки не будут грузиться, то об этом так же сформируются соответствующие отчёты —

в отдельном файле с полным путём картинки, которую не удалось загрузить, адресом поста, а так же с причиной этой неудачи:

![пример отчёта загрузки записей раз](http://www.canitell.ru/imgs/livejougit/Failed_image_download_report.png)

и в метаинформации о загрузке постов по месяцам:

![пример отчёта загрузки записей раз](http://www.canitell.ru/imgs/livejougit/Failed_image_download_in-posts_download_report.png)


### Что ещё может случиться:


```
----------------------------------------------------------------------------------------------------
Huh... Banned? Or...? there are 3 versions, good and bad:
----------------------------------------------------------------------------------------------------
1. good: there are no posts or journal entries according to your input (given journal, year(s) or period of time)

2. bad: I'm banned... you've used me carelessly!

3. good: if you're the journal's owner please untick the option that your content is for adults if it is so
- only after that I may look through your journal __unless I'm banned__
```

Т.е.:

1. нет записей за заданный период или нет такого журнала
2. получен бан: ваш IP занесён в список тех ботов, которые слишком непосредственны и навязчивы…
3. журнал только для взрослых, тогда надо снять галочку о том в настройках своего ЖЖ
